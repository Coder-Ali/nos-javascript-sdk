function Uploader(l){var c,b;c=$.extend({},{urlDns:"http://lbs-eastchina1.126.net/lbs",retryCount:2,fileInputID:"fileInput",timeout:5E4,onError:function(a){console.log(a)},onProgress:function(a){console.log(a.status);console.log(a.progress)}},l);return b={version:"1.0",uploadFile:null,edgeNodeList:null,dnsRetryCount:0,uTRetryCount:c.retryCount,gORetryCount:c.retryCount,gDRetryCount:c.retryCount,createAjax:function(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},
clearStorage:function(a){localStorage.removeItem(a+"_progress");localStorage.removeItem(a+"_context");localStorage.removeItem(a+"_created")},addFile:function(a,d){if(a){var c=CryptoJS.MD5(a.name+":"+a.size).toString();a={fileKey:c,file:a,fileName:a.name,status:0,progress:localStorage.getItem(c+"_progress")||0};b.uploadFile&&(b.uploadFile=null);b.uploadFile=$.extend(!0,{},a);localStorage.setItem(c+"_created",+new Date);d&&d(a)}},getFile:function(a){var d;b.uploadFile.fileKey===a&&(d=b.uploadFile);
return d},getDNS:function(a,d){if(void 0===a||null===a||""===a)a="";b.edgeNodeList?d(b.edgeNodeList):$.ajax({type:"get",url:c.urlDns,data:{version:b.version,bucketname:a},dataType:"json",success:function(a,e,h){if(a.code)c.onError({errCode:a.Code,errMsg:a.Message});else b.edgeNodeList=a.upload,d(a.upload,a.lbs)},error:function(f,e,h){f.status.toString().match(/^5/)&&0<b.gDRetryCount&&b.gDRetryCount<c.retryCount+1?(b.getDNS(a,d),b.gDRetryCount--):(c.onError(f.responseText),b.gDRetryCount=c.retryCount)}})},
getOffset:function(a,d){var f;f=localStorage.getItem(a.fileKey+"_context");if(!f)return d(0);$.ajax({type:"get",url:a.serveIp+"/"+a.bucketName+"/"+encodeURIComponent(a.objectName)+"?uploadContext",data:{version:b.version,context:f},dataType:"json",beforeSend:function(b){b.setRequestHeader("x-nos-token",a.token)},success:function(a,b,g){if(a.errCode)c.onError({errCode:a.errCode,errMsg:a.errMsg});else d(a.offset)},error:function(e,f,g){e.status.toString().match(/^5/)&&0<b.gORetryCount&&b.gORetryCount<
c.retryCount+1?(b.getOffset(a,d),b.gORetryCount--):(c.onError(e.responseText),b.gORetryCount=c.retryCount,404===e.status&&b.clearStorage(a.fileKey))}})},uploadTrunk:function(a,d,f){var e,h="",g,m,l=File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice;g=b.getFile(d.fileKey);m=localStorage.getItem(d.fileKey+"_context");g.xhr?e=g.xhr:(e=b.createAjax(),g.xhr=e);e.upload.onprogress=function(a){if(a.lengthComputable)a=(d.offset+a.loaded)/d.file.size,g.progress=(100*
a).toFixed(2),0<a&&1>a?(g.status=1,$("#"+c.fileInputID).attr("disabled",!0)):1===a&&(g.status=2,$("#"+c.fileInputID).attr("disabled",!1)),localStorage.setItem(d.fileKey+"_progress",g.progress),c.onProgress(g);else c.onError({errMsg:"\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u8fdb\u5ea6\u4e8b\u4ef6"})};e.onreadystatechange=function(){if(4===e.readyState){var k;try{k=JSON.parse(e.responseText)}catch(n){k={errMsg:"\u672a\u77e5\u9519\u8bef"}}if(200===e.status)0===g.file.size&&(g.status=2,g.progress=100,c.onProgress(g)),
localStorage.setItem(d.fileKey+"_context",k.context),k.offset<d.file.size?b.uploadTrunk(a,$.extend({},d,{offset:k.offset,trunkEnd:k.offset+d.trunkSize,context:m||k.context}),f):f(d);else if(e.status.toString().match(/^5/))if(b.uTRetryCount<c.retryCount+1&&0<b.uTRetryCount)b.getOffset({serveIp:a.serveIp,bucketName:a.bucketName,objectName:a.objectName,token:a.token,fileKey:d.fileKey},function(c){b.uploadTrunk(a,$.extend({},d,{offset:c,trunkEnd:c+d.trunkSize,context:localStorage.getItem(d.fileKey+"_context")||
""}),f)}),b.uTRetryCount--;else if(b.dnsRetryCount<b.edgeNodeList.length-1){b.uTRetryCount=c.retryCount;b.dnsRetryCount++;var h=$.extend({},a,{serveIp:b.edgeNodeList[b.dnsRetryCount]});b.getOffset({serveIp:h.serveIp,bucketName:h.bucketName,objectName:h.objectName,token:h.token,fileKey:d.fileKey},function(a){b.uploadTrunk(h,$.extend({},d,{offset:a,trunkEnd:a+d.trunkSize,context:localStorage.getItem(d.fileKey+"_context")||""}),f)})}else b.dnsRetryCount=0,c.onError({errCode:k.errCode,errMsg:k.errMsg}),
$("#"+c.fileInputID).attr("disabled",!1),b.clearStorage(d.fileKey);else $("#"+c.fileInputID).attr("disabled",!1),e.status?(b.clearStorage(d.fileKey),c.onError({errCode:k.errCode,errMsg:k.errMsg})):console.log("\u4e0a\u4f20\u5df2\u6682\u505c")}};h="?offset="+d.offset+"&complete="+(d.trunkEnd>=d.file.size)+"&context="+(m||d.context)+"&version="+b.version;e.open("post",a.serveIp+"/"+a.bucketName+"/"+encodeURIComponent(a.objectName)+h);e.setRequestHeader("x-nos-token",a.token);e.timeout=c.timeout;e.send(l.call(d.file,d.offset,
d.trunkEnd))},pauseUpload:function(){var a;if(b.uploadFile)if(b.uploadFile.xhr)if(2>b.uploadFile.status)a=b.uploadFile.xhr,a.abort(),$("#"+c.fileInputID).attr("disabled",!1);else c.onError({errMsg:"\u5f53\u524d\u6587\u4ef6\u5df2\u5b8c\u6210\u4e0a\u4f20"});else c.onError({errMsg:"\u5f53\u524d\u6587\u4ef6\u672a\u5f00\u59cb\u4e0a\u4f20"});else c.onError({errMsg:"\u672a\u9009\u62e9\u9700\u4e0a\u4f20\u7684\u6587\u4ef6"})},upload:function(a,d){if(a.bucketName||0===a.bucketName)if(a.objectName||0===a.objectName)if(a.token)if(a.trunkSize||
(a.trunkSize=131072),b.uploadFile){var f=b.uploadFile;b.getDNS(a.bucketName,function(e,h){if(0===e.length)c.onError({errMsg:"\u6682\u65e0\u8fb9\u7f18\u8282\u70b9"});else b.getOffset({serveIp:e[0],bucketName:a.bucketName,objectName:a.objectName,fileKey:f.fileKey,token:a.token},function(c){b.uploadTrunk({serveIp:e[0],bucketName:a.bucketName,objectName:a.objectName,token:a.token},{file:f.file,fileKey:f.fileKey,offset:c||0,trunkSize:a.trunkSize,trunkEnd:(c||0)+a.trunkSize,context:""},function(a){b.clearStorage(a.fileKey);
d&&d(f)})})})}else c.onError({errMsg:"\u672a\u9009\u62e9\u9700\u4e0a\u4f20\u7684\u6587\u4ef6"});else c.onError({errMsg:"\u4e0a\u4f20\u51ed\u8bc1\u4e0d\u80fd\u4e3a\u7a7a"});else c.onError({errMsg:"\u5bf9\u8c61\u540d\u4e0d\u80fd\u4e3a\u7a7a"});else c.onError({errMsg:"\u6876\u540d\u4e0d\u80fd\u4e3a\u7a7a"})}}};